<html>
<head>
<title>
	SOCPrint! - Printing made simplier
</title>
<link rel="stylesheet" href="style.css">	
<script src="jquery-2.1.4.min.js"></script>
<script type="text/javascript">

var isLoggingIn = false;

// Start of upload script
$(document).ready(function()
{

var form = document.forms.namedItem("uploadFile");

form.addEventListener("submit", function(ev, ef) 
{

  
   var oOutput = document.getElementById("uploadMSG");
   var formData = new FormData(document.forms.namedItem("uploadFile"));

	formData.append("username", document.getElementById("username").value);
	formData.append("password", document.getElementById("password").value);
	var loginMSG =	 document.getElementById("loginMSG");
	loginMSG.innerHTML = "SOMETHING CHANGED";
  
  var oReq = new XMLHttpRequest();
  oReq.open("POST", "fileUpload.php", true);
  oReq.onload = function(oEvent) 
  {
    if (oReq.readyState == 4)
	{
      oOutput.innerHTML = oReq.responseText;
    } else 
	{
      oOutput.innerHTML = "Error " + oReq.status + " occurred uploading your file.<br \/>";
    }
  };

  oReq.send(formData);
  ev.preventDefault();
}, false);
});
// End of upload script

// xmlhttp version
function checkServer() 
{
	var xmlhttp = new XMLHttpRequest();
	if (xmlhttp==null)
	{
		document.getElementById("serverStatus").innerHTML = "XMLHttpRequest not supported. Status unknown.";
		return;
	}
        xmlhttp.onreadystatechange = function() 
		{
            if (xmlhttp.readyState == 4) 
			{
                document.getElementById("serverStatus").innerHTML = xmlhttp.responseText;
            }
        }
	xmlhttp.open("GET", "isOnline.php", true);
	xmlhttp.send();
	
    
}
// xmlhttp version
function sendCommand()
{
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.open("POST", "SendCommand.php", true);
	xmlhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
	xmlhttp.send("name=" + document.getElementById("username").value + "&password=" + document.getElementById("password").value);
	
	xmlhttp.onreadystatechange = function() 
	{
		if (xmlhttp.readyState == 4) 
		{
			document.getElementById("printerStatus").innerHTML = xmlhttp.responseText;
		}
	}
}
// xmlhttp version
function fileUpload()
{
	var isLoggedIn = document.getElementById("login").innerHTML;
	var loginMSG =	 document.getElementById("loginMSG");
	if (isLoggedIn == "Login")
	{
		loginMSG.style.color = "red";
		loginMSG.innerHTML = "Please login first";	
	}
	else
	{
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.open("POST", "fileUpload.php", true);
		xmlhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
		
		
		loginMSG.style.color = "orange";
		loginMSG.innerHTML = "Uploading Now";
		
		var formData = FormData();
		formData.append("username", document.getElementById("username").value);
		formData.append("password", document.getElementById("password").value);
		formData.append("file", document.getElementById("file").value);
		
		document.getElementById("file");
		xmlhttp.onreadystatechange = function() 
		{
			document.getElementById("uploadMSG").innerHTML = xmlhttp.responseText;
		}
	}
}
// Ajax version
function checkLogin()
{
	var loginMSG =	 document.getElementById("loginMSG");	
	// If is logging in, dont allow another ajax submittion, exit immediately
	if(isLoggingIn)
	{	
		return;		
	}	
	// Checks for login and pw to be both entered before submitting ajax
	if(document.getElementById("login").innerHTML == "Login")
	{
		if(document.getElementById("username").value == "")
		{
			loginMSG.style.color = "red";
			loginMSG.innerHTML = "Please enter your username";	
			return;
		}
		if(document.getElementById("password").value == "")
		{
			loginMSG.style.color = "red";
			loginMSG.innerHTML = "Please enter your password";			
			return;
		}		
		// Ajax to login php
		$.ajax(
		{ 	
			type: 'post',
			url: "checklogin.php",
			data: JSON.stringify({name : document.getElementById("username").value, password : document.getElementById("password").value}),
			success: function(data)
			{				
				data = JSON.parse(data);
				switch(data)
				{
					case "NO_CONNECTION":
					{
						loginMSG.style.color = "red";
						loginMSG.innerHTML = "Unable to connect to sunfire";
						break;
					}
					case "WRONG":
					{
						loginMSG.style.color = "red";
						loginMSG.innerHTML = "Incorrect username or password";
						break;
					}
					case "OK":
					{
						document.getElementById("login").innerHTML = "Disconnect";
						loginMSG.style.color = "lime";
						loginMSG.innerHTML = "Logged in successfully";
						document.getElementById("username").disabled = true;
						document.getElementById("password").disabled = true;
						sendCommand();
						break;
					}
					default :
					{
						loginMSG.style.color = "red";
						loginMSG.innerHTML = "Unknown: " + data;
						break;
					}
				}
				// Enable login again
				isLoggingIn = false;
			}
		})	
		isLoggingIn = true;		
		loginMSG.style.color = "orange";
		loginMSG.innerHTML = "Logging In Now";
	}
	else
	{
		document.getElementById("login").innerHTML = "Login";
		document.getElementById("username").value = "";
		document.getElementById("password").value = "";
		
		loginMSG.style.color = "lime";
		loginMSG.innerHTML = "Disconnected in successfully";
		document.getElementById("username").disabled = false;
		document.getElementById("password").disabled = false;
	}
}
</script>


</head>
<body onload="checkServer()">

<header>
<table id="header">
<tbody>
	<tr>
		<td>
			<img src="img/logo_big.png" alt="SOCPrint!" style="width:12em;height:3em; float:left">
		</td>
		<td>
			<p id="serverStatus">	
				Server status: Checking
			</p>
		</td>
		<td id="loginBox">
			<table>
				<tr id="loginStatus">
					<td>
						<div id="loginMSG"><br>	</div>
					</td>
				</tr>
				<tr>
					<td>
						<input id="username" class="textbox" type="text" name="name" placeholder="Sunfire ID e.g. a0123456 or tanbc"><br>
						<input id="password" class="textbox" type="password" name="password" placeholder="Password"><br>
			
					</td>

					<td>
						<a onclick="checkLogin()" class="loginBtn" type="button" id="login">Login</a>
					</td>
				</tr>
			</table>
		</td>
	</tr>
</tbody>
</table>
</header>
<div class="content">
<div class="center">
<table>
	<br>
	<tr>
		<td>
			<table>
				<tr width="100%" align="center">
				Printer Selection
				</tr>
				<tr>
				<td><input type="radio" name="printer" value="psts">psts</td>
				<td><input type="radio" name="printer" value="psts">pstsb</td>
				<td><input type="radio" name="printer" value="psts">pstsc</td>
				</tr>
			</table>
			<form enctype="multipart/form-data" method="post" name="uploadFile" onsubmit="return false" style ="border: 5px outset blue">
				<input id="file" type="file" name="file"><br>
				<input type="submit" name="submit">
				<div id="uploadMSG">PLACEHOLDER: Upload message <br>File restriction of < 50mb</div>
			</form>
		<td>
	</tr>	
</table>
<table>
	<tr>
		<td>
		
		<div id="printerStatus">Printer status and quota will be available after login.</div>
		</td>
	</tr>
</table>
</div>
</div>
</body>
</html>